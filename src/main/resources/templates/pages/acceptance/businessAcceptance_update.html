<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>管理分区</title>
    <link rel="stylesheet" type="text/css" href="../../../statics/newlayui/layui/css/layui.css">
</head>
<body>
<form class="layui-form">
    <table class="layui-table" style="width: 98%;margin: 1px auto;text-align: center;">
        <tbody>
        <tr>
            <td class="layui-bg-gray" width="13%">业务通知单号</td>
            <td width="22%">
                <input type='hidden' lay-verify="id" name='id' th:value="${session.id}" id="id"/>
                <input type="text" name="businessNoticeNo" id="businessNoticeNo" lay-verify="required" placeholder="请输入业务通知单号" autocomplete="off" class="layui-input" th:value="${session.noticeNo}" disabled>
            </td>
            <td class="layui-bg-gray" width="10%">客户编号</td>
            <td width="22%">
                <input type="text" name="customCode" id="customCode" lay-verify="required" placeholder="请输入客户编号" autocomplete="off" class="layui-input" value="">
            </td>
            <td class="layui-bg-gray" width="10%">客户名称</td>
            <td width="22%">
                <input type="text" name="customName" id="customName" lay-verify="required" placeholder="请输入客户名称" autocomplete="off" class="layui-input" value="">
            </td>
        </tr>
        <tr>

            <td class="layui-bg-gray">客户电话</td>
            <td>
                <input type="text" name="telPhone" id="telPhone" lay-verify="required|phone" placeholder="请输入电话" autocomplete="off" class="layui-input" value="">
            </td>
            <td class="layui-bg-gray">派送地址</td>
            <td colspan="3">
                <input type="text" name="sendAddress" id="sendAddress" lay-verify="required|addr1|addr" placeholder="请输入派送地址(XX区+详细地址)" autocomplete="off" class="layui-input" value="">
            </td>

        </tr>
        <tr>
            <!--<td class="layui-bg-gray">取件人</td>
            <td>
                <input type="text" name="pickupAddress" id="pickupAddress" lay-verify="required|addr|addr1" placeholder="请输入取件地址(XX区+详细地址)" autocomplete="off" class="layui-input" value="">
            </td>-->
            <td class="layui-bg-gray">取件城市</td>
            <td>
                <input type="text" name="city" id="city" lay-verify="required|act1|act" placeholder="请输入取件城市" autocomplete="off" class="layui-input" value="">
            </td>
            <td class="layui-bg-gray">取件地址</td>
            <td colspan="3">
                <input type="text" name="pickupAddress" id="pickupAddress" lay-verify="required|addr|addr1" placeholder="请输入取件地址(XX区+详细地址)" autocomplete="off" class="layui-input" value="">
            </td>
        </tr>
        <tr>
            <td class="layui-bg-gray">收件人</td>
            <td>
                <input type="text" name="sendMan" id="sendMan" lay-verify="required" placeholder="请输入收件人" autocomplete="off" class="layui-input" value="">
            </td>
            <td class="layui-bg-gray">收件人号码</td>
            <td>
                <input type="text" name="sendPhone" id="sendPhone" lay-verify="required|phone" placeholder="请输入收件人号码" autocomplete="off" class="layui-input" value="">
            </td>
            <td class="layui-bg-gray">到达城市</td>
            <td>
                <input type="text" name="arriveCity" id="arriveCity" lay-verify="required|act1|city1" placeholder="请输入到达城市" autocomplete="off" class="layui-input" value="">
            </td>


        </tr>
        <tr>
            <td class="layui-bg-gray">预约取件时间</td>
            <td>
                <input type="text" lay-verify="required" name="reservationTime" id="reservationTime" placeholder="请输入预约取件时间" autocomplete="off" class="layui-input" value="">
            </td>
            <td class="layui-bg-gray" >产品</td>
            <td>
                <select lay-verify="required" name="production" id="production">
                    <option value="" id=""></option>
                    <option value="0" id="0">日用百货</option>
                    <option value="1" id="1">服饰箱包</option>
                    <option value="2" id="2">护肤彩妆</option>
                    <option value="3" id="3">珠宝配饰</option>
                    <option value="4" id="4">家居装饰</option>
                </select>
            </td>
            <td class="layui-bg-gray">件数</td>
            <td>
                <input type="text" name="packagesNum" id="packagesNum" lay-verify="required|num" placeholder="请输入件数" autocomplete="off" class="layui-input" value="">
            </td>
        </tr>
        <tr>
            <td class="layui-bg-gray">体积</td>
            <td>
                <input type="text" name="volume" id="volume" lay-verify="required|number" placeholder="请输入体积" autocomplete="off" class="layui-input" value="">
            </td>
            <td class="layui-bg-gray">重量</td>
            <td>
                <input type="text" name="weight" id="weight" lay-verify="required|number" placeholder="请输入重量" autocomplete="off" class="layui-input" value="">
            </td>
            <td class="layui-bg-gray">备注</td>
            <td colspan="2">
                <input type="text" name="importantHints" id="importantHints" lay-verify="required" placeholder="请输入备注" autocomplete="off" class="layui-input" value="">
            </td>
        </tr>

        <tr>
            <td colspan="6">
                <button class="layui-btn" style="background: #1da02b;" lay-filter="update" lay-submit="">确定</button>
                <button type="button" class="layui-btn layui-btn-primary" id="closePage">取消</button>
            </td>
        </tr>
        </tbody>
    </table>
</form>
<script type="text/javascript" src="../../../statics/custom/jquery.min.js"></script>
<script type="text/javascript" src="../../../statics/newlayui/layui/layui.js"></script>
<script type="text/javascript">
    //返回
    $("#closePage").click(function(){
        var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
        parent.layer.close(index);//关闭弹出的子页面窗口
    });

    layui.use(['form', 'layedit','layer','laydate'], function(){
        $ = layui.jquery;
        var form = layui.form
            ,layer = layui.layer,
            layedit =layui.layedit,
            laydate=layui.laydate;
        var id = $("#id").val();
        $.ajax({
            url:"/queryById",
            data:{'id':id},
            type:"post",
            success:function(data){
                var obj=$.parseJSON(data);
                $("#businessNoticeNo").val(obj.businessNoticeNo);//业务通知单号
                $("#customCode").val(obj.customCode);//客户编号
                $("#customName").val(obj.customName);//客户名称
                $("#telPhone").val(obj.telPhone);//电话
                $("#sendAddress").val(obj.sendAddress);//派送地址
                $("#pickupAddress").val(obj.pickupAddress);//取件地址
                $("#arriveCity").val(obj.arriveCity+'市');//到达城市
                $("#packagesNum").val(obj.packagesNum);//取件数
                $("#reservationTime").val(obj.reservationTime);//取件时间
                $("#production").each(function(){
                    $("#"+obj.production).prop("selected",true);
                    form.render(); //更新全部
                });
                $("#weight").val(obj.weight);//重量
                $("#volume").val(obj.volume);//体积
                $("#city").val(obj.city+'市');
                $("#importantHints").val(obj.importantHints);//备注
                $("#sendPhone").val(obj.sendPhone); //收件号码
                $("#sendMan").val(obj.sendMan);//收件人
            }
        });

        //监听提交
        form.on('submit(update)', function(data){
            var id = $("#id").val();
            var businessNoticeNo = $("#businessNoticeNo").val();//业务通知单号
            var customCode = $("#customCode").val();//客户编号
            var customName = $("#customName").val();//客户名称
            var telPhone = $("#telPhone").val();//电话
            var sendAddress = $("#sendAddress").val();//派送地址
            var pickupAddress = $("#pickupAddress").val();//取件地址
            var arriveCity = $("#arriveCity").val();//到达城市
            var packagesNum = $("#packagesNum").val();//取件数
            var reservationTime = $("#reservationTime").val();//取件时间
            var production = $("#production").val();//产品
            var weight = $("#weight").val();//重量
            var volume = $("#volume").val();//体积
            var importantHints = $("#importantHints").val();//备注
            var city = $("#city").val();//取件城市
            var sendPhone=$("#sendPhone").val(); //收件号码
            var sendMan=$("#sendMan").val();//收件人
            layer.alert("修改成功！", {icon: 6},function () {
                // 获得frame索引
                $.ajax({
                    type:'post',
                    data:{'businessNoticeNo':''+businessNoticeNo+'','customCode':''+customCode+'','customName':
                            ''+customName+'','telPhone':''+telPhone+'','sendAddress':''+sendAddress+'','pickupAddress':''+pickupAddress+'',
                        'arriveCity':''+arriveCity+'','packagesNum':''+packagesNum+'','reservationTime':''+reservationTime+'','production':''+production+''
                        ,'weight':''+weight+'','volume':''+volume+'','importantHints':''+importantHints+'','city':''+city+'','id':''+id+'',
                       'sendMan':''+sendMan+'','sendPhone':''+sendPhone+''},
                    url:'/updateWork',
                    success:function (a) {
                        if("a"!=a){
                            alert(a);
                        }
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.location.reload(); //刷新父页面
                        //关闭当前frame
                        parent.layer.close(index);
                    }
                })
            });
            return false;
        });

        $("#telPhone").blur(function () {
            var telPhone = $("#telPhone").val();
            $.ajax({
                type:'post',
                url:'/queryCusByPhone/'+telPhone+'',
                success:function(data){
                    var obj=$.parseJSON(data);
                    $("#customCode").val(obj.customCode);
                    $("#customName").val(obj.customName);
                    $("#pickupAddress").val(obj.cstomAddress);
                }
            });
        });
        $("#pickupAddress").blur(function () {
            var pickupAddress = $("#pickupAddress").val();
            if(!/.*区/.test(pickupAddress)){
                layer.msg("只能输入XX区+详细地址的格式！",{icon:5});
                return;
            }
            $.ajax({
                type:'post',
                url:'/ifExitsAddr/'+pickupAddress+'',
                success: function(data){
                    if(data == 'null'){
                        layer.msg("你填写的地址不正确！",{icon:5});
                    }
                }
            });
        });

        $("#sendAddress").blur(function () {
            var sendAddress = $("#sendAddress").val();
            if(!/.*区/.test(sendAddress)){
                layer.msg("只能输入XX区+详细地址的格式！",{icon:5});
                return;
            }
            $.ajax({
                type:'post',
                url:'/ifExitsAddr/'+sendAddress+'',
                success: function(data){
                    if(data == 'null'){
                        layer.msg("你填写的地址不正确！",{icon:5});
                    }
                }
            });
        });

        $("#city").blur(function () {
            var city = $("#city").val();
            var pickupAddress = $("#pickupAddress").val();
            if(!/.*区/.test(pickupAddress)){
                layer.msg("只能输入XX区+详细地址的格式！",{icon:5});
                return;
            }
            if(!/.*市/.test(city)){
                layer.msg("只能输入XX市的格式！",{icon:5});
                return;
            }
            $.ajax({
                type:'post',
                url:'/ifMatch',
                data:{'city':''+city+'','pickupAddress':''+pickupAddress+''},
                success: function(data){
                    if(data == '0'){
                        layer.msg("你填写的城市与地址不匹配！",{icon:5});
                    }
                }
            })
        });
        /* /ifCity*/
        $("#arriveCity").blur(function () {
            var arriveCity=$("#arriveCity").val();
            if(!/.*市/.test(arriveCity)){
                layer.msg("只能输入XX市的格式！",{icon:5});
                return;
            }
            $.ajax({
                type:'post',
                url:'/ifCity',
                data:{'arriveCity':''+arriveCity+''},
                success: function(data){
                    if(data == '0'){
                        layer.msg("你填写的城市不正确！",{icon:5});
                    }
                }
            })
        });


        //日期
        $(this).removeAttr("lay-key");
        var reservationTime= laydate.render({
            elem: '#reservationTime'
            ,type: 'datetime'
            ,trigger : 'click',
            min:'nowTime'
        });


        //创建一个编辑器
        var editIndex = layedit.build('LAY_demo_editor');

        //自定义验证规则
        form.verify({
            num: function(value, item){ //value：表单的值、item：表单的DOM对象
                if(!/^\d+$/.test(value)){
                    return '格式不正确';
                }
            },
            addr:function (value,item) {
                if(!/.*区/.test(value)){
                    return '只能输入XX区+详细地址的格式！';
                }
            }
            ,
            addr1:function(value,item){
                var msg ='';
                $.ajax({
                    type:'post',
                    url:'/ifExitsAddr/'+value+'',
                    async:false,
                    success: function(data){
                        if(data == 'null'){
                            msg="你填写的地址不正确！",{icon:5};
                        }
                    }
                });
                return msg;
            },
            act1:function(value,item){
                if(!/.*市/.test(value)){
                    return '只能输入XX市的格式！';
                }
            },
            act:function(value,item){
                var msg = '';
                var pickupAddress = $("#pickupAddress").val();
                $.ajax({
                    type:'post',
                    url:'/ifMatch',
                    async:false,
                    data:{'city':''+value+'','pickupAddress':''+pickupAddress+''},
                    success: function(data){
                        if(data == '0'){
                            msg="你填写的城市与地址不匹配！";
                        }
                    }
                });
                return msg;
            },
            city1:function(value,item){
                var msg = '';
                $.ajax({
                    type:'post',
                    url:'/ifCity',
                    async:false,
                    data:{'arriveCity':''+value+''},
                    success: function(data){
                        if(data == '0'){
                            msg= "你填写的城市不正确！";
                        }
                    }
                });
                return msg;
            },
            content: function(value){
                layedit.sync(editIndex);
            }
        });
    });



</script>
</body>
</html>
